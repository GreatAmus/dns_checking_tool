<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DNS Settings Checker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

  <style>
    :root{
      /* Softer, cleaner look */
      --card-border: rgba(0,0,0,.12);
      --muted: rgba(0,0,0,.72);
      --muted-2: rgba(0,0,0,.58);
      --surface-1: #ffffff;
      --surface-2: rgba(0,0,0,.015);
      --pill-bg: rgba(0,0,0,.02);

      --ok: #0a7;
      --bad: #b00020;
      --warn: #b45309;
    }

    body{ font-size: 16px; line-height: 1.45; }
    main.container{ max-width: 1020px; }
    h1{ font-size: 1.9rem; margin-bottom: .25rem; }
    h2{ font-size: 1.25rem; margin: 0; }
    h3{ font-size: 1.05rem; margin: 0; }

    .muted{ color: var(--muted); opacity: 1; font-size: .95em; }
    .ok{ color: var(--ok); font-weight: 800; }
    .bad{ color: var(--bad); font-weight: 800; }
    .warn{ color: var(--warn); font-weight: 800; }

    /* Layout wrappers to reduce nested “box inside box” */
    .block{
      margin: 1.25rem 0;
      padding-top: .25rem;
    }
    .block-head{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: .75rem;
      flex-wrap: wrap;
      margin-bottom: .75rem;
    }
    .rule{ height: 1px; background: rgba(0,0,0,.08); margin: .5rem 0 0 0; }

    /* Summary as a flat grid (no big box) */
    .summary-grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: .75rem;
      margin-top: .75rem;
    }
    .summary-card{
      grid-column: span 4;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      padding: .85rem .9rem;
      background: var(--surface-1);
    }
    @media (max-width: 900px){
      .summary-card{ grid-column: span 12; }
    }
    .summary-label{ color: var(--muted-2); font-weight: 700; font-size: .85em; }
    .summary-value{ margin-top: .25rem; font-weight: 900; font-size: 1.05em; }
    .summary-sub{ margin-top: .35rem; color: var(--muted); font-size: .9em; }

    /* Severity pills */
    .pills{ margin-top: .6rem; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding: .12rem .48rem;
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 999px;
      font-size: .82em;
      margin-right: .35rem;
      margin-bottom: .35rem;
      background: var(--pill-bg);
      white-space: nowrap;
      color: rgba(0,0,0,.78);
    }
    .pill strong{ font-weight: 800; color: rgba(0,0,0,.86); }
    .pill .count{ font-weight: 900; }

    /* Toolbar */
    .toolbar{
      display:grid;
      grid-template-columns: 1fr 220px;
      gap: .75rem;
      align-items: end;
      margin: .75rem 0 1rem 0;
    }
    @media (max-width: 900px){ .toolbar{ grid-template-columns: 1fr; } }

    /* NEW: check toggles row */
    .check-toggles{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      gap:.5rem;
      flex-wrap:wrap;
      margin-top:.25rem;
    }
    .check-pill{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding: .18rem .55rem;
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 999px;
      background: rgba(0,0,0,.02);
      font-size: .9em;
      user-select:none;
    }
    .check-pill input{ margin: 0; }

    /* Finding cards */
    details > summary{ cursor: pointer; }
    .finding{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      padding: .75rem .9rem;
      margin: .6rem 0;
      background: var(--surface-1);
    }
    .finding summary{
      list-style:none;
      display:grid;
      grid-template-columns: 96px 1fr;
      gap: .8rem;
      align-items: start;
    }
    .finding summary::-webkit-details-marker{ display:none; }

    .sev{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: .14rem .55rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.14);
      font-size: .82em;
      font-weight: 800;
      text-transform: lowercase;
      background: transparent;
    }
    .sev.high, .sev.medium{ color: var(--bad); border-color: rgba(176,0,32,.22); }
    .sev.low{ color: var(--warn); border-color: rgba(180,83,9,.22); }
    .sev.info{ color: var(--ok); border-color: rgba(0,170,119,.22); }
    .sev.unknown{ opacity: .75; }

    .finding-title{ font-weight: 900; margin: 0; line-height: 1.25; font-size: 1rem; }
    .finding-meta{
      margin-top: .2rem;
      display:flex;
      flex-wrap: wrap;
      gap: .4rem;
      align-items:center;
    }

    /* Key/value rows */
    .kvs{
      display:grid;
      grid-template-columns: 230px 1fr;
      gap: .35rem .75rem;
      margin-top: .7rem;
    }
    @media (max-width: 700px){ .kvs{ grid-template-columns: 1fr; } }
    .kvs .key{ font-weight: 800; color: var(--muted-2); }

    /* WRAP FIXES + softer blocks */
    pre{
      max-height: 34vh;
      overflow:auto;
      margin: .5rem 0 0 0;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;

      background: rgba(0,0,0,.02);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      padding: .75rem .85rem;
      font-size: .92em;
      line-height: 1.35;
    }
    table td, table th{
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
    }
    code{
      font-size: .9em;
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
      background: rgba(0,0,0,.04);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 8px;
      padding: .05rem .3rem;
    }

    /* “What to fix” */
    .fixbox{
      display:grid;
      gap: .75rem;
      grid-template-columns: 1fr 160px;
      align-items: start;
      margin-top: .5rem;
    }
    @media (max-width: 800px){ .fixbox{ grid-template-columns: 1fr; } }

    textarea{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      white-space: pre;
      overflow-wrap: normal;
      font-size: .92em;
      line-height: 1.35;
      background: #fff;
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 12px;
    }

    /* New: “fix items” with extra context */
    .fix-hint{
      margin-top: .5rem;
      color: var(--muted);
      font-size: .92em;
    }

    /* Raw JSON affordance */
    details.raw summary{
      display:inline-flex;
      align-items:center;
      gap: .5rem;
      padding: .35rem .6rem;
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 10px;
      background: rgba(0,0,0,.02);
      font-weight: 800;
      user-select:none;
      font-size: .92em;
    }
    details.raw summary:hover{ background: rgba(0,0,0,.04); }

    /* Status */
    #status p{ margin: .5rem 0; }
  </style>
</head>

<body>
<main class="container">
  <h1>DNS Settings Checker</h1>
  <p class="muted">Enter a domain/zone (e.g., <code>example.com</code>) and run the checks.</p>

  <form id="form">
    <label>
      Domain / zone
      <input id="zone" placeholder="example.com" required />
    </label>
    <button type="submit">Check</button>
  </form>

  <div id="status"></div>

  <section id="results" style="display:none;">
    <!-- SUMMARY (no big outer card) -->
    <div class="block" id="summaryBlock">
      <div class="block-head">
        <h2>Summary</h2>
        <div class="muted" id="summaryTagline"></div>
      </div>
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Zone</div>
          <div class="summary-value" id="zoneOut"></div>
          <div class="summary-sub">The exact name checked (after normalization).</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Score</div>
          <div class="summary-value" id="scoreOut"></div>
          <div class="summary-sub">Higher is better. Aim for 85+.</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Issues</div>
          <div class="summary-value" id="issuesOut"></div>
          <div class="summary-sub">Total findings returned by all checks.</div>
        </div>
      </div>

      <div class="pills" id="severityPills"></div>
      <div class="rule"></div>
    </div>

    <!-- FINDINGS (no big nested boxes; just headings + cards) -->
    <div class="block">
      <div class="block-head">
        <h2>Findings</h2>
        <div class="muted">Filter by severity or search within titles/details.</div>
      </div>

 <div class="toolbar">
  <label style="margin:0;">
    Search (title/detail/issue)
    <input id="searchBox" placeholder="e.g. CAA, DNSSEC, timeout…" />
  </label>

  <label style="margin:0;">
    Severity
    <select id="severityFilter">
      <option value="all">All</option>
      <option value="high">High</option>
      <option value="medium">Medium</option>
      <option value="low">Low</option>
      <option value="info">Info</option>
      <option value="unknown">Unknown</option>
    </select>
  </label>

  <!-- NEW: Check toggles -->
      <div class="check-toggles">
        <span class="muted" style="font-weight:800;">Checks</span>
        <label class="check-pill"><input type="checkbox" id="toggleHealth" checked /> Health</label>
        <label class="check-pill"><input type="checkbox" id="toggleDNSSEC" checked /> DNSSEC</label>
        <label class="check-pill"><input type="checkbox" id="toggleCAA" checked /> CAA</label>
        <label class="check-pill"><input type="checkbox" id="toggleMPIC" checked /> MPIC</label>
      </div>
    </div>
    <div>
      <div id="healthSection"></div>
      <div id="dnssecSection"></div>
      <div id="caaSection"></div>
      <div id="mpicSection"></div>
      <div id="otherSection"></div>

      <div class="rule"></div>
    </div>

    <!-- WHAT TO FIX (more descriptive) -->
    <div class="block">
      <div class="block-head">
        <h2>What to fix</h2>
        <div class="muted">A prioritized, copy/paste checklist with context.</div>
      </div>

      <div class="fixbox">
        <textarea id="fixList" rows="12" readonly></textarea>
        <button id="copyFix" type="button">Copy</button>
      </div>
      <div class="fix-hint" id="fixHint"></div>

      <div class="rule"></div>
    </div>

    <details class="raw">
      <summary>Show raw response JSON</summary>
      <pre id="rawOut">{}</pre>
    </details>
  </section>
</main>

<script>
  const form = document.getElementById("form");
  const zoneInput = document.getElementById("zone");
  const status = document.getElementById("status");
  const results = document.getElementById("results");

  const zoneOut = document.getElementById("zoneOut");
  const scoreOut = document.getElementById("scoreOut");
  const issuesOut = document.getElementById("issuesOut");
  const severityPills = document.getElementById("severityPills");
  const summaryTagline = document.getElementById("summaryTagline");

  const rawOut = document.getElementById("rawOut");

  const searchBox = document.getElementById("searchBox");
  const severityFilter = document.getElementById("severityFilter");

  const healthSection = document.getElementById("healthSection");
  const dnssecSection = document.getElementById("dnssecSection");
  const caaSection = document.getElementById("caaSection");
  const mpicSection = document.getElementById("mpicSection");
  const otherSection = document.getElementById("otherSection");

  const fixList = document.getElementById("fixList");
  const copyFix = document.getElementById("copyFix");
  const fixHint = document.getElementById("fixHint");

  const NO_REC_SENTINEL = "No recommendation available for this issue yet.";

  let lastFindings = [];
  let lastChecks = {};
    const toggleHealth = document.getElementById("toggleHealth");
    const toggleDNSSEC = document.getElementById("toggleDNSSEC");
    const toggleCAA = document.getElementById("toggleCAA");
    const toggleMPIC = document.getElementById("toggleMPIC");

    function enabledChecks() {
      return {
        health: !!toggleHealth.checked,
        dnssec: !!toggleDNSSEC.checked,
        caa: !!toggleCAA.checked,
        mpic: !!toggleMPIC.checked,
        other: true, // keep “Other” always visible; change to a toggle if you want
      };
    }

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function badge(text, ok) {
    return `<span class="${ok ? "ok" : "bad"}">${esc(text)}</span>`;
  }

  function pill(label, value) {
    return `<span class="pill"><strong>${esc(label)}:</strong> <span class="count">${esc(value)}</span></span>`;
  }

  function sevClass(sev) {
    sev = String(sev || "unknown").toLowerCase();
    return ["high","medium","low","info","unknown"].includes(sev) ? sev : "unknown";
  }

  function normalizeFinding(f, idx) {
    const check = f.check || "";
    const issue = f.issue || "";
    const title = f.title || "";
    const detail = f.detail || "";
    const recRaw = (f.recommendation || "").trim();
    const rec = (recRaw && recRaw !== NO_REC_SENTINEL) ? recRaw : "";
    const severity = sevClass(f.severity);

    return {
      id: `finding-${idx}`,
      check, issue, title, detail, severity,
      recommendation: rec
    };
  }
  function categoryForFinding(f) {
    const check = String(f.check || "").toLowerCase();
    const issue = String(f.issue || "").toLowerCase();
    const title = String(f.title || "").toLowerCase();
    const hay = `${check} ${issue} ${title}`;

    if (check === "dns_health" || hay.includes("dns_health") || hay.includes("health")) return "health";
    if (hay.includes("dnssec")) return "dnssec";
    if (hay.includes("caa")) return "caa";
    if (hay.includes("mpic")) return "mpic";

    return "other";
  }


  function passesFilters(f) {
    // NEW: exclude disabled categories from search/filter/render/checklist
    const cat = categoryForFinding(f);
    const en = enabledChecks();
    if (!en[cat]) return false;

    const sev = severityFilter.value;
    if (sev !== "all" && f.severity !== sev) return false;

    const q = (searchBox.value || "").trim().toLowerCase();
    if (!q) return true;

    const hay = `${f.check} ${f.issue} ${f.title} ${f.detail} ${f.recommendation}`.toLowerCase();
    return hay.includes(q);
  }


  function groupByCheck(findings) {
    const groups = new Map();
    for (const f of findings) {
      const key = (f.check || "unknown");
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(f);
    }
    const keys = Array.from(groups.keys()).sort((a,b) => String(a).localeCompare(String(b)));
    return keys.map(k => [k, groups.get(k)]);
  }

  function renderSummary(summary) {
    const s = summary || {};
    const score = (typeof s.score === "number") ? s.score : null;
    const issues = (typeof s.issues === "number") ? s.issues : null;

    scoreOut.innerHTML = score === null ? badge("unknown", false) : badge(String(score), score >= 85);
    issuesOut.textContent = issues === null ? "unknown" : String(issues);

    // Quick tagline without another box
    const fail = (s.high || 0) > 0 || (s.medium || 0) > 0;
    summaryTagline.innerHTML = "";

    const pills = [];
    for (const k of ["high","medium","low","info","unknown"]) {
      if (typeof s[k] === "number") pills.push(pill(k, s[k]));
    }
    severityPills.innerHTML = pills.join("");
  }

  function renderHealthInline(checks) {
    const h = (checks && checks.dns_health) ? checks.dns_health : null;
    if (!h) return `<p class="muted">(No DNS health data.)</p>`;

    const overall = (h.overall || "unknown").toLowerCase();
    const ns = Array.isArray(h.nameservers) ? h.nameservers : [];

    const overallOk = (overall === "ok");
    const overallLine = `<p><strong>Overall:</strong> ${badge(overall, overallOk)}</p>`;

    const nsLine = ns.length
      ? `<p class="muted"><strong>Delegated NS:</strong> ${ns.map(x => `<code>${esc(x)}</code>`).join(" ")}</p>`
      : `<p class="muted">(No delegated NS returned.)</p>`;

    return overallLine + nsLine;
  }

  function renderCAAInline(checks) {
    const caa = (checks && checks.caa) ? checks.caa : null;
    if (!caa) return `<p class="muted">(No CAA data.)</p>`;

    const records = Array.isArray(caa.records) ? caa.records : [];
    const eff = caa.effective_domain || "";
    const inherited = !!caa.inherited;

    const allowsAny = (caa.allows_any_issuance !== false);
    const allowsWild = (caa.allows_wildcards !== false);
    const allowsDcNon = (caa.allows_digicert_nonwild !== false);
    const allowsDcWild = (caa.allows_digicert_wild !== false);

    const recordLine = records.length
      ? `<p><strong>CAA record(s):</strong> ${records.map(r => `<code>${esc(r)}</code>`).join(" ")}</p>`
      : `<p class="muted">No CAA records found (zone not restricted by CAA).</p>`;

    const effLine = records.length
      ? `<p class="muted"><strong>Effective at:</strong> <code>${esc(eff)}</code> ${inherited ? `<span class="pill"><strong>inherited</strong> yes</span>` : ""}</p>`
      : "";

    const evalPills = `
      <div class="pills">
        ${pill("issuance", allowsAny ? "allowed" : "blocked")}
        ${pill("wildcards", allowsWild ? "allowed" : "blocked")}
        ${pill("DigiCert non-wild", allowsDcNon ? "allowed" : "not allowed")}
        ${pill("DigiCert wild", allowsDcWild ? "allowed" : "not allowed")}
      </div>
    `;

    return recordLine + effLine + evalPills;
  }

  function renderMPICInline(checks) {
    const mp = (checks && checks.mpic) ? checks.mpic : null;
    if (!mp) return `<p class="muted">(No MPIC data.)</p>`;

    const level = mp.risk_level || "unknown";
    const score = (typeof mp.risk_score === "number") ? mp.risk_score : null;

    const header = `
      <p><strong>Risk:</strong> ${badge(level, level === "low")}
      ${score === null ? "" : `<span class="muted">(score ${esc(score)})</span>`}</p>
    `;

    const queries = Array.isArray(mp.queries) ? mp.queries : [];
    if (!queries.length) return header + `<p class="muted">(No MPIC queries returned.)</p>`;

    const divergent = queries.filter(q => q && q.consistent === false);
    const top = divergent.length
      ? `<p class="bad"><strong>Divergence detected</strong> on ${divergent.length} query(s).</p>`
      : `<p class="ok"><strong>No divergence</strong> across perspectives.</p>`;

    let rows = "";
    for (const q of queries) {
      const consistent = q.consistent === true;
      const divP = Array.isArray(q.divergent_perspectives) ? q.divergent_perspectives : [];
      rows += `
        <tr>
          <td><code>${esc(q.qname || "")}</code></td>
          <td><code>${esc(q.qtype || "")}</code></td>
          <td>${badge(consistent ? "yes" : "no", consistent)}</td>
          <td>${divP.length ? divP.map(p => `<span class="pill"><strong>p</strong> ${esc(p)}</span>`).join("") : ""}</td>
        </tr>
      `;
    }

    return header + top + `
      <details ${divergent.length ? "open" : ""}>
        <summary>Show MPIC query details</summary>
        <table>
          <thead><tr>
            <th>Name</th><th>Type</th><th>Consistent</th><th>Divergent</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </details>
    `;
  }

  function renderCategorySection(container, title, findings, extraHtml) {
    if (!findings.length && !extraHtml) {
      container.innerHTML = "";
      return;
    }

    const groups = groupByCheck(findings);

    let html = `
      <div style="margin-top:1.25rem;">
        <div style="display:flex; align-items:baseline; justify-content:space-between; gap:.75rem; flex-wrap:wrap;">
          <h3>${esc(title)}</h3>
          <span class="pill"><strong>findings</strong> <span class="count">${esc(findings.length)}</span></span>
        </div>
        ${extraHtml ? `<div style="margin:.35rem 0 .85rem 0;">${extraHtml}</div>` : ""}
    `;

    if (!groups.length) {
      html += `<p class="muted">(No findings in this section.)</p>`;
    } else {
      for (const [checkName, items] of groups) {
        html += `<p class="muted" style="margin: .75rem 0 .25rem 0;"><strong>Check:</strong> <code>${esc(checkName)}</code></p>`;

        for (const f of items) {
          const titleText = (f.title && f.title.trim()) ? f.title : (f.issue ? f.issue : "(no title)");
          const issuePill = f.issue ? `<span class="pill"><strong>issue</strong>: <code>${esc(f.issue)}</code></span>` : "";
          const recBlock = f.recommendation
            ? `<pre>${esc(f.recommendation)}</pre>`
            : `<p class="muted">(No recommendation yet)</p>`;

          html += `
            <details class="finding" id="${esc(f.id)}" open>
              <summary>
                <span class="sev ${esc(f.severity)}">${esc(f.severity)}</span>
                <div>
                  <p class="finding-title">${esc(titleText)}</p>
                  <div class="finding-meta">${issuePill}</div>
                </div>
              </summary>

              <div class="kvs">
                <div class="key">Detail</div>
                <div>${f.detail ? `<pre>${esc(f.detail)}</pre>` : `<span class="muted">(none)</span>`}</div>

                <div class="key">Recommendation</div>
                <div>${recBlock}</div>
              </div>
            </details>
          `;
        }
      }
    }

    html += `</div>`;
    container.innerHTML = html;
  }

  function buildWhatToFixChecklist(findingsAll) {
    // More descriptive checklist:
    // - group by category
    // - include issue + check name
    // - include 1-line “why it matters” extracted from title/detail when possible

    const actionable = findingsAll.filter(f => f.recommendation && f.recommendation.trim());
    if (!actionable.length) {
      fixList.value = "";
      fixHint.textContent = "(No actionable recommendations returned.)";
      return;
    }
    const order = { health: 0, dnssec: 1, caa: 2, mpic: 3, other: 4 };
    const byCat = new Map();

    for (const f of actionable) {
      const cat = categoryForFinding(f);
      if (!byCat.has(cat)) byCat.set(cat, []);
      byCat.get(cat).push(f);
    }

    const cats = Array.from(byCat.keys()).sort((a,b) => (order[a] ?? 9) - (order[b] ?? 9));
    const lines = [];

    for (const cat of cats) {
      const items = byCat.get(cat) || [];
      items.sort((a,b) => String(a.check).localeCompare(String(b.check)));

      lines.push(`## ${cat.toUpperCase()}`);
      for (const f of items) {
        const titleText = (f.title && f.title.trim()) ? f.title : (f.issue ? f.issue : "(no title)");
        const check = f.check ? f.check : "unknown-check";
        const issue = f.issue ? f.issue : "unknown-issue";

        // Tiny “context” line: pull first sentence-ish from detail if present
        const context = (f.detail || "").trim().split(/\n+/)[0].slice(0, 140);
        const ctxLine = context ? `\n    - Context: ${context}${context.length >= 140 ? "…" : ""}` : "";

        lines.push(`- [ ] ${titleText}`);
        lines.push(`    - Check: ${check}`);
        lines.push(`    - Issue: ${issue}`);
        lines.push(`    - Fix: ${f.recommendation.trim()}${ctxLine}`);
      }
      lines.push(""); // spacer
    }

    fixList.value = lines.join("\n").trim();
    fixHint.textContent = "Tip: items are grouped by area (DNSSEC/CAA/MPIC/Other) and include check + issue for quick triage.";
  }

  function rerender() {
    const filtered = lastFindings.filter(passesFilters);

    const health = filtered.filter(f => categoryForFinding(f) === "health");
    const dnssec = filtered.filter(f => categoryForFinding(f) === "dnssec");
    const caa = filtered.filter(f => categoryForFinding(f) === "caa");
    const mpic = filtered.filter(f => categoryForFinding(f) === "mpic");
    const other = filtered.filter(f => categoryForFinding(f) === "other");

    const en = enabledChecks();

    // Requested order: Health, DNSSEC, CAA, MPIC
    renderCategorySection(healthSection, "DNS Health", en.health ? health : [], en.health ? renderHealthInline(lastChecks) : "");
    renderCategorySection(dnssecSection, "DNSSEC", en.dnssec ? dnssec : [], "");
    renderCategorySection(caaSection, "CAA", en.caa ? caa : [], en.caa ? renderCAAInline(lastChecks) : "");
    renderCategorySection(mpicSection, "MPIC", en.mpic ? mpic : [], en.mpic ? renderMPICInline(lastChecks) : "");

    renderCategorySection(otherSection, "Other", other, "");

    // Checklist should also respect toggles
    buildWhatToFixChecklist(lastFindings.filter(passesFilters));
  }

  searchBox.addEventListener("input", rerender);
  severityFilter.addEventListener("change", rerender);

  copyFix.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(fixList.value || "");
      copyFix.textContent = "Copied";
      setTimeout(() => copyFix.textContent = "Copy", 1200);
    } catch (e) {
      fixList.focus();
      fixList.select();
    }
  });
  toggleHealth.addEventListener("change", rerender);
  toggleDNSSEC.addEventListener("change", rerender);
  toggleCAA.addEventListener("change", rerender);
  toggleMPIC.addEventListener("change", rerender);

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    status.innerHTML = "Checking…";
    results.style.display = "none";

    dnssecSection.innerHTML = "";
    caaSection.innerHTML = "";
    mpicSection.innerHTML = "";
    otherSection.innerHTML = "";
    severityPills.innerHTML = "";
    fixList.value = "";
    fixHint.textContent = "";
    rawOut.textContent = "{}";
    summaryTagline.textContent = "";

    const zone = zoneInput.value.trim().replace(/\.$/, "");
    try {
      const res = await fetch(`/check?zone=${encodeURIComponent(zone)}`);
      if (!res.ok) {
        const t = await res.text();
        status.innerHTML = `<p class="bad">Request failed (${res.status})</p><pre>${esc(t)}</pre>`;
        return;
      }

      const data = await res.json();
      rawOut.textContent = JSON.stringify(data, null, 2);

      zoneOut.textContent = data.target || zone;
      renderSummary(data.summary);

      const findingsRaw = Array.isArray(data.findings) ? data.findings : [];
      lastFindings = findingsRaw.map(normalizeFinding);

      lastChecks = data.checks || {};
      rerender();

      // Keep status simple
      const s = data.summary || {};
      const fail = (s.high || 0) > 0 || (s.medium || 0) > 0;
      status.innerHTML = fail
        ? `<p class="bad">FAIL — see findings below.</p>`
        : `<p class="ok">PASS</p>`;

      results.style.display = "block";
    } catch (err) {
      status.innerHTML = `<p class="bad">Error</p><pre>${esc(err)}</pre>`;
    }
  });
</script>
</body>
</html>
