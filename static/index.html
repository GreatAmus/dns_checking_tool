<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DNS Settings Checker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    .ok { color: #0a7; font-weight: 700; }
    .bad { color: #b00020; font-weight: 700; }
    pre { max-height: 40vh; overflow: auto; margin: 0; }
    img { width: 100%; height: auto; border-radius: 10px; border: 1px solid #ddd; }
    .muted { opacity: .8; font-size: .95em; }
    table td, table th { vertical-align: top; }
    code { font-size: 0.9em; }
    .pill {
      display: inline-block;
      padding: .15rem .5rem;
      border: 1px solid rgba(0,0,0,.15);
      border-radius: 999px;
      font-size: .85em;
      margin-right: .35rem;
      margin-bottom: .35rem;
      background: rgba(0,0,0,.03);
    }
  </style>
</head>
<body>
<main class="container">
  <h1>DNS Settings Checker</h1>
  <p class="muted">
    Enter a domain/zone (e.g., <code>example.com</code>). You’ll get the scan results + analytics graph.
  </p>

  <form id="form">
    <label>
      Domain / zone
      <input id="zone" placeholder="example.com" required />
    </label>
    <button type="submit">Check</button>
  </form>

  <div id="status"></div>

  <section id="results" style="display:none;">
    <h2>Summary</h2>
    <p><strong>Zone:</strong> <span id="zoneOut"></span></p>
    <p><strong>Overall:</strong> <span id="overallOut"></span></p>
    <p><strong>Nameservers:</strong> <span id="nsOut"></span></p>

    <h2>Findings</h2>
    <div id="findingsOut"></div>

    <h2>Recommendations</h2>
    <p class="muted">Action items inferred from the findings.</p>
    <div id="recsOut"></div>

    <h2>Graph</h2>
    <p class="muted">This is generated server-side from the analytics output.</p>
    <img id="graph" alt="Analytics graph" />

    <details>
      <summary>Raw JSON</summary>
      <pre id="raw">{}</pre>
    </details>
  </section>
</main>

<script>
  const form = document.getElementById("form");
  const zoneInput = document.getElementById("zone");
  const status = document.getElementById("status");
  const results = document.getElementById("results");

  const zoneOut = document.getElementById("zoneOut");
  const overallOut = document.getElementById("overallOut");
  const nsOut = document.getElementById("nsOut");
  const findingsOut = document.getElementById("findingsOut");
  const recsOut = document.getElementById("recsOut");
  const raw = document.getElementById("raw");
  const graph = document.getElementById("graph");

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function badge(text, ok) {
    return `<span class="${ok ? "ok" : "bad"}">${esc(text)}</span>`;
  }

  function uniqueNonEmpty(arr) {
    const out = [];
    const seen = new Set();
    for (const x of arr) {
      const v = String(x ?? "").trim();
      if (!v) continue;
      const k = v.toLowerCase();
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(v);
    }
    return out;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    status.innerHTML = "Checking…";
    results.style.display = "none";
    findingsOut.innerHTML = "";
    recsOut.innerHTML = "";
    raw.textContent = "{}";
    graph.removeAttribute("src");

    const zone = zoneInput.value.trim().replace(/\.$/, "");
    try {
      const res = await fetch(`/check?zone=${encodeURIComponent(zone)}`);
      if (!res.ok) {
        const t = await res.text();
        status.innerHTML = `<p class="bad">Request failed (${res.status})</p><pre>${esc(t)}</pre>`;
        return;
      }

      const data = await res.json();
      raw.textContent = JSON.stringify(data, null, 2);

      zoneOut.textContent = data.zone || zone;

      const ok = (data.overall || "").toLowerCase() === "pass";
      overallOut.innerHTML = badge(data.overall || "unknown", ok);

      const ns = Array.isArray(data.nameservers) ? data.nameservers : [];
      nsOut.textContent = ns.length ? ns.join(", ") : "(none found)";

      const findings = Array.isArray(data.findings) ? data.findings : [];

      // Render findings table
      if (!findings.length) {
        findingsOut.innerHTML = `<p class="ok">No findings reported.</p>`;
      } else {
        let html = `
          <table>
            <thead><tr>
              <th>Issue</th>
              <th>Server</th>
              <th>Repro</th>
              <th>Detail</th>
              <th>Recommendation</th>
            </tr></thead>
            <tbody>
        `;

        for (const f of findings) {
          html += `
            <tr>
              <td><code>${esc(f.issue)}</code></td>
              <td>${esc(f.server)}</td>
              <td><code>${esc(f.repro)}</code></td>
              <td><pre>${esc(f.detail)}</pre></td>
              <td><pre>${esc(f.recommendation)}</pre></td>
            </tr>
          `;
        }

        html += `</tbody></table>`;
        findingsOut.innerHTML = html;
      }

      // Render recommendations section (deduped)
      const recs = uniqueNonEmpty(findings.map(f => f.recommendation));
      if (!recs.length) {
        recsOut.innerHTML = `<p class="muted">(No recommendations.)</p>`;
      } else {
        recsOut.innerHTML = `
          <ul>
            ${recs.map(r => `<li>${esc(r)}</li>`).join("")}
          </ul>
        `;
      }

      // Load graph PNG (cache-bust with timestamp)
      graph.src = `/graph.png?zone=${encodeURIComponent(zone)}&t=${Date.now()}`;

      status.innerHTML = ok
        ? `<p class="ok">PASS</p>`
        : `<p class="bad">FAIL — see findings below.</p>`;

      results.style.display = "block";
    } catch (err) {
      status.innerHTML = `<p class="bad">Error</p><pre>${esc(err)}</pre>`;
    }
  });
</script>
</body>
</html>
